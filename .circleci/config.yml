version: 2.1

orbs:
  android: circleci/android@3.0.2
  ruby: circleci/ruby@2.3.1
  gcp-cli: circleci/gcp-cli@3.3.0
  continuation: circleci/continuation@1.1.0

setup: true

aliases:
  - &workspace
      ~/passkeys-sdk
  - &unit-test-folder-result
      ~/test-results/junit
  - &tmp-workspace
      tmp/workspace
  - &env-vars-file
      env_vars

  - android-publish-release-tag-filter: &android-publish-release
      filters:
        tags:
          only:
            - /^release-passkeys-android-\d+\.\d+\.\d+$/
        branches:
          ignore: /.*/

  - ios-publish-release-tag-filter: &ios-publish-release
      filters:
        tags:
          only:
            - /^release-passkeys-ios-\d+\.\d+\.\d+$/
        branches:
          ignore: /.*/

executors:
  ubuntu-small-executor:
    # https://circleci.com/developer/images/image/cimg/base
    docker:
      - image: cimg/base:2025.02
    resource_class: small
    working_directory: *workspace

  android-executor:
    docker:
      # https://circleci.com/developer/images/image/cimg/android#image-tags
      - image: cimg/android:2025.02.1
    resource_class: medium
    working_directory: *workspace

  android-node-executor:
    docker:
      # https://circleci.com/developer/images/image/cimg/android#image-tags
      - image: cimg/android:2025.02.1-node
    resource_class: medium
    working_directory: *workspace

  mac-os-executor:
    macos:
      xcode: "15.1.0"
    resource_class: macos.m1.medium.gen1
    working_directory: *workspace

  ruby-executor:
    docker:
      - image: cimg/ruby:3.3.0
    working_directory: *workspace

parameters:
  generate-app:
    type: boolean
    default: false
  e2e-tests:
    type: boolean
    default: false

commands:
  test-results-folder:
    parameters:
      folder:
        default: *unit-test-folder-result
        type: string
    steps:
      - run:
          name: Copying tests results to <<parameters.folder>>
          command: |
            mkdir -p <<parameters.folder>>
            find . -type f -regex ".*/build/test-results/.*xml" -exec cp {} <<parameters.folder>> \;
          when: always
          working_directory: *workspace

  install-jdk-17:
    steps:
      - run:
          name: Install OpenJDK 17
          command: |
            sudo apt-get update && sudo apt-get install openjdk-17-jdk
            sudo update-alternatives --set java /usr/lib/jvm/java-17-openjdk-amd64/bin/java
            sudo update-alternatives --set javac /usr/lib/jvm/java-17-openjdk-amd64/bin/javac
            java -version

  danger-check:
    parameters:
      danger_params:
        type: string
    steps:
      - run:
          name: Danger check
          command: bundle exec danger <<parameters.danger_params>> --verbose --remove-previous-comments

  move-directory:
    parameters:
      from:
        description: directory to move
        type: string
      to:
        description: destination directory
        type: string
    steps:
      - run: cp -R <<parameters.from>> <<parameters.to>>

  install-firebase-cli:
    steps:
      - run:
          name: Install Firebase CLI
          command: npm install --save-dev firebase-tools
  set-sample-backend-for-ios:
    steps:
      - run:
          name: Set sample backend URL
          command: |
            SAMPLE_BACKEND_DOMAIN="${SAMPLE_BACKEND_URL/https:\/\/}"
            SAMPLE_BACKEND_DOMAIN="${SAMPLE_BACKEND_DOMAIN/\/}"
            cd iosApp
            sed -i '' "s|let domain: String = \".*\"|let domain: String = \"${SAMPLE_BACKEND_DOMAIN}\"|" iosApp/Constants.swift
            sed -i '' "s|<string>webcredentials:.*</string>|<string>webcredentials:${SAMPLE_BACKEND_DOMAIN}</string>|" iosApp/iosApp.entitlements
  setup-certificates:
    steps:
      - run:
          name: Install Apple Certificate and Provisioning Profile
          command: |
            ./scripts/certificates_setup.sh setup

  cleanup-signing:
    steps:
      - run:
          name: Clean Up Keychain and Provisioning Profile
          command: |
            ./scripts/certificates_setup.sh cleanup

jobs:
  assemble:
    executor: android-executor

    steps:
      - checkout
      - android/restore_build_cache
      - android/restore_gradle_cache
      - ruby/install-deps
      - run:
          name: Assemble build
          command: ./gradlew assembleDebug :shared:assembleRelease assembleDebugAndroidTest
      - move-directory:
          from: shared/build/outputs/apk/androidTest/debug/
          to: builds
      - move-directory:
          from: shared/build/outputs/aar/
          to: builds
      - danger-check:
          danger_params: --danger_id=assemble --dangerfile=dangerfiles/dangerfile_pr_validation
      - android/save_gradle_cache
      - android/save_build_cache
      - persist_to_workspace:
          root: *workspace
          paths:
            - builds

  lint-check:
    executor: ruby-executor

    steps:
      - checkout
      - android/restore_build_cache
      - android/restore_gradle_cache
      - ruby/install-deps
      - install-jdk-17
      - run:
          name: Kotlin lint
          command: ./gradlew ktlintCheck
      - danger-check:
          danger_params: --danger_id=lint --dangerfile=dangerfiles/dangerfile_ktlint
      - android/save_gradle_cache
      - android/save_build_cache

  detekt-check:
    executor: android-executor

    steps:
      - checkout
      - android/restore_build_cache
      - android/restore_gradle_cache
      - ruby/install-deps
      - run:
          name: Detekt check
          command: ./gradlew detekt
      - danger-check:
          danger_params: --danger_id=detekt --dangerfile=dangerfiles/dangerfile_detekt
      - android/save_gradle_cache
      - android/save_build_cache

  android-unit-tests:
    executor: android-executor

    steps:
      - checkout
      - android/restore_build_cache
      - android/restore_gradle_cache
      - ruby/install-deps
      - run:
          name: Kover code coverage report
          command: ./gradlew :shared:koverXmlReportDebug
      - danger-check:
          danger_params: --danger_id=unit_tests --dangerfile=dangerfiles/dangerfile_code_coverage
      - run:
          name: Kover code coverage rule
          command: ./gradlew :shared:koverVerify
      - android/save_gradle_cache
      - android/save_build_cache
      - test-results-folder
      - store_test_results:
          path: *unit-test-folder-result
      - store_artifacts:
          path: /home/circleci/test-results/

  android-instrumented-tests:
    executor: android-executor

    steps:
      - checkout
      - attach_workspace:
          at: *workspace
      - android/restore_build_cache
      - android/restore_gradle_cache
      - gcp-cli/install
      - run:
          name: Initialize gcloud CLI to connect to Google Cloud
          command: |
            echo $GCLOUD_SERVICE_KEY | base64 --decode > ${HOME}/gcloud-service-key.json
            gcloud auth activate-service-account --key-file=${HOME}/gcloud-service-key.json
            gcloud --quiet config set project "$GOOGLE_PROJECT_ID"
      - run:
          name: Run android instrumented tests in Firebase test lab - Device Pixel 6 Api 33
          command: |
            gcloud firebase test android run --app ftl/dummy.apk --test builds/shared-debug-androidTest.apk --device model=oriole,version=33,locale=en,orientation=portrait

  ios-unit-tests:
    executor: mac-os-executor

    steps:
      - checkout
      - android/restore_build_cache
      - android/restore_gradle_cache
      - run:
          name: Run Unit tests
          command: ./gradlew :shared:iosSimulatorArm64Test
      - android/save_gradle_cache
      - android/save_build_cache
      - test-results-folder
      - store_test_results:
          path: *unit-test-folder-result
      - store_artifacts:
          path: /Users/distiller/test-results/

  android-sdk-size-report:
    executor: android-executor

    steps:
      - checkout
      - android/restore_build_cache
      - android/restore_gradle_cache
      - ruby/install-deps
      - run:
          name: Android SDK size report
          command: ./gradlew generateSizeReport
      - store_artifacts:
          path: "shared/build/outputs/sizeReport"
          destination: sizeReport
      - move-directory:
          from: shared/build/outputs/sizeReport/
          to: builds
      - danger-check:
          danger_params: --danger_id=android_sdk_report --dangerfile=dangerfiles/dangerfile_android_sdk_size_report
      - persist_to_workspace:
          root: *workspace
          paths:
            - builds

  ios-sdk-size-report:
    executor: mac-os-executor

    steps:
      - checkout
      - ruby/install-deps
      - run:
          name: Install Gem dependencies
          command: |
            cd iosApp
            bundle install
      - setup-certificates
      - run:
          name: Build and measure
          command: |
            cd iosApp
            bundle exec fastlane size_demo_app
      - danger-check:
          danger_params: --danger_id=ios_sdk_report --dangerfile=dangerfiles/dangerfile_ios_sdk_size_report
      - cleanup-signing
      - persist_to_workspace:
            root: .
            paths:
              - iosApp/IPAs/iosApp.ipa

  ios-generate-framework:
    executor: mac-os-executor

    steps:
      - checkout
      - run:
          name: Create Framework
          command: ./gradlew shared:assembleTwilioPasskeysAuthenticationXCFramework
      - run:
          name: Compress Artifacts
          command: ./scripts/compress_xcframework.sh
      - store_artifacts:
          path: debugFramework.zip
      - store_artifacts:
          path: releaseFramework.zip
      - persist_to_workspace:
            root: *workspace
            paths:
              - debugFramework.zip
              - releaseFramework.zip

  android-generate-aar:
    
    executor: android-executor

    steps:
      - checkout
      - attach_workspace:
          at: *workspace
      - run:
          name: Create aars
          command: |
            mv builds/aar/shared-debug.aar TwilioPasskeys-debug.aar
            mv builds/aar/shared-release.aar TwilioPasskeys.aar
      - store_artifacts:
          path: TwilioPasskeys-debug.aar
      - store_artifacts:
          path: TwilioPasskeys.aar

  release-kmp:
    executor: ruby-executor

    steps:
      - checkout
      - attach_workspace:
          at: *workspace
      - run:
          name: Starting KMP release
          command: echo "Starting KMP SDK release"
          environment:
            TMP_WORKSPACE: *tmp-workspace
            ENV_VARS_FILE: *env-vars-file
      - continuation/continue:
          configuration_path: .circleci/release_kmp.yml

  release-ios:
    executor: ruby-executor

    steps:
      - checkout
      - attach_workspace:
          at: *workspace
      - run:
          name: Starting iOS release
          command: echo "Starting iOS SDK release"
          environment:
            TMP_WORKSPACE: *tmp-workspace
            ENV_VARS_FILE: *env-vars-file
      - continuation/continue:
          configuration_path: .circleci/release_ios.yml

  generate-android-sample-app-using-local-sdk:
    executor: android-node-executor

    steps:
      - checkout
      - android/restore_build_cache
      - android/restore_gradle_cache
      - attach_workspace:
          at: *workspace
      - run:
          name: Set sample backend URL
          command: |
            ./scripts/update_gradle_properties.sh sampleBackendUrl \"${SAMPLE_BACKEND_URL}\" androidApp/gradle.properties
      - run:
          name: Generate simulator build
          command: ./scripts/build_android_simulator_app.sh
          environment:
            TMP_WORKSPACE: *tmp-workspace
            ENV_VARS_FILE: *env-vars-file
      - store_artifacts:
          path: sample-app.zip
      - install-firebase-cli
      - run:
          name: Deploy to Firebase App Distribution
          command: |
            firebase appdistribution:distribute sample-app.apk --app $FIREBASE_ANDROID_APP_ID --token $FIREBASE_TOKEN --groups qa --debug --release-notes "Sample app with Local SDK" | tee firebase_app_distribution_output.log
      - persist_to_workspace:
          root: *workspace
          paths:
            - *tmp-workspace

  generate-ios-sample-app-using-internal-sdk:
    executor: mac-os-executor

    steps:
      - checkout
      - ruby/install-deps
      - attach_workspace:
          at: .
      - run:
          name: Install Gem dependencies
          command: |
            cd iosApp
            bundle install
      - run:
          name: Configure GCloud App Distribution service
          command: echo -n "$GCLOUD_SERVICE_KEY" | base64 --decode -o ${HOME}/gcloud-app-distribution-service-key.json
      - set-sample-backend-for-ios
      - setup-certificates
      - run:
          name: Deploy to Firebase App Distribution
          command: |
            cd iosApp
            bundle exec fastlane deploy_demo_app
          environment:
            TMP_WORKSPACE: *tmp-workspace
            ENV_VARS_FILE: *env-vars-file
      - cleanup-signing
      - persist_to_workspace:
          root: .
          paths:
            - iosApp/fastlane/firebase_url.txt

  generate-ios-simulator-app-using-internal-sdk:
    executor: mac-os-executor

    steps:
      - checkout
      - ruby/install-deps
      - attach_workspace:
          at: *workspace
      - run:
          name: Install Gem dependencies
          command: |
            cd iosApp
            bundle install
      - set-sample-backend-for-ios
      - setup-certificates
      - run:
          name: Generate simulator build
          command: ./scripts/build_ios_simulator_app.sh
          environment:
            TMP_WORKSPACE: *tmp-workspace
            ENV_VARS_FILE: *env-vars-file
      - cleanup-signing
      - store_artifacts:
          path: iosApp/sample-app.zip
      - persist_to_workspace:
          root: *workspace
          paths:
            - *tmp-workspace

  run-android-local-sdk-e2e-tests:
    executor: ubuntu-small-executor

    parameters:
      waiting_job_name:
        default: ""
        type: string

    steps:
      - checkout
      - attach_workspace:
          at: *workspace
      - run:
          name: Start automation pipeline to run E2E tests
          command: |
            source "$TMP_WORKSPACE/$ENV_VARS_FILE"
            TRIGGER_PIPELINE=$(./scripts/e2e_tests/run_android_e2e_tests.sh $ANDROID_APP_DOWNLOAD_URL $CIRCLE_WORKFLOW_ID << parameters.waiting_job_name >>)
            echo "Trigger pipeline: $TRIGGER_PIPELINE"
          environment:
            TMP_WORKSPACE: *tmp-workspace
            ENV_VARS_FILE: *env-vars-file
      - persist_to_workspace:
          root: *workspace
          paths:
            - *tmp-workspace

  run-simulator-ios-local-sdk-e2e-tests:
    executor: ubuntu-small-executor

    parameters:
      waiting_job_name:
        default: ""
        type: string
    steps:
      - checkout
      - attach_workspace:
          at: *workspace
      - run:
          name: Start automation pipeline to run E2E tests
          command: |
            source "$TMP_WORKSPACE/$ENV_VARS_FILE"
            TRIGGER_PIPELINE=$(./scripts/e2e_tests/run_ios_e2e_tests.sh $IOS_SIMULATOR_APP_URL $CIRCLE_WORKFLOW_ID << parameters.waiting_job_name >>)
            echo "Trigger pipeline: $TRIGGER_PIPELINE"
          environment:
            TMP_WORKSPACE: *tmp-workspace
            ENV_VARS_FILE: *env-vars-file
      - persist_to_workspace:
          root: *workspace
          paths:
            - *tmp-workspace

  check-local-sdk-e2e-tests-result:
    executor: ubuntu-small-executor

    parameters:
      job_name_to_check:
        default: ""
        type: string
    steps:
      - checkout
      - attach_workspace:
          at: *workspace
      - run:
          name: Check triggered job status
          command: |
            RESULT=$(./scripts/e2e_tests/check_triggered_e2e_tests_pipeline_approval_by.sh $CIRCLE_WORKFLOW_ID << parameters.job_name_to_check >>)
            echo "Trigger pipeline status: $RESULT"
          environment:
            TMP_WORKSPACE: *tmp-workspace
            ENV_VARS_FILE: *env-vars-file

  wait-passkey-tests-passed:
    executor: ubuntu-small-executor
    description: "Waits for all tests to finish"
    steps:
      - run:
          name: All tests passed
          command: echo "All tests passed"

workflows:
  build-all:
    when:
      and:
        - equal: [ false, << pipeline.parameters.generate-app >> ]
        - equal: [ false, << pipeline.parameters.e2e-tests >> ]
    jobs:
      - assemble:
          context:
            - verify-passkeys
      - lint-check:
          context:
            - verify-passkeys
          requires:
            - assemble
      - android-sdk-size-report:
          context:
            - verify-passkeys
          requires:
            - assemble
      - ios-sdk-size-report:
          context:
            - verify-passkeys
            - verify-passkeys-ios
          requires:
            - assemble
      - detekt-check:
          context:
            - verify-passkeys
          requires:
            - assemble
      - android-unit-tests:
          context:
            - verify-passkeys
          requires:
            - lint-check
            - detekt-check
      - android-instrumented-tests:
          context:
            - verify-passkeys
          requires:
            - android-unit-tests
      - ios-unit-tests:
          context:
            - verify-passkeys
          requires:
            - lint-check
            - detekt-check
      - ios-generate-framework:
          context:
            - verify-passkeys
          requires:
            - ios-unit-tests
      - generate-ios-simulator-app-using-internal-sdk:
          context:
            - verify-passkeys
            - verify-passkeys-ios
          requires:
            - ios-generate-framework
      - android-generate-aar:
          requires:
            - android-instrumented-tests
      - generate-android-sample-app-using-local-sdk:
          context:
            - verify-passkeys
            - verify-passkeys-android
          requires:
            - android-instrumented-tests
            - ios-unit-tests
      - run-android-local-sdk-e2e-tests:
          context:
            - verify-passkeys
          waiting_job_name: wait-for-android-local-sdk-e2e-tests
          requires:
            - generate-android-sample-app-using-local-sdk
          filters:
            branches:
              only:
                - dev
      - wait-for-android-local-sdk-e2e-tests:
          type: approval
          requires:
            - run-android-local-sdk-e2e-tests
      - check-local-sdk-e2e-tests-result:
          name: check-android-local-sdk-e2e-tests-result
          context:
            - verify-passkeys
          job_name_to_check: "wait-for-android-local-sdk-e2e-tests"
          requires:
            - wait-for-android-local-sdk-e2e-tests:
                - success
                - failed
                - canceled
      - generate-ios-sample-app-using-internal-sdk:
          context:
            - verify-passkeys
            - verify-passkeys-ios
          requires:
            - ios-sdk-size-report
            - ios-generate-framework
      - run-simulator-ios-local-sdk-e2e-tests:
          context:
            - verify-passkeys
            - verify-passkeys-ios
          waiting_job_name: wait-for-ios-local-sdk-e2e-tests
          requires:
            - generate-ios-simulator-app-using-internal-sdk
          filters:
            branches:
              only:
                - dev
      - wait-for-ios-local-sdk-e2e-tests:
          type: approval
          requires:
            - run-simulator-ios-local-sdk-e2e-tests
      - check-local-sdk-e2e-tests-result:
          name: check-simulator-ios-sdk-e2e-tests-result
          context:
            - verify-passkeys
          job_name_to_check: "wait-for-ios-local-sdk-e2e-tests"
          requires:
            - wait-for-ios-local-sdk-e2e-tests:
                - success
                - failed
                - canceled
      - wait-passkey-tests-passed:
          requires:
            - check-android-local-sdk-e2e-tests-result
            - check-simulator-ios-sdk-e2e-tests-result

  release-kmp-sdk:
    jobs:
      - release-kmp:
          <<: *android-publish-release

  release-ios-sdk:
    jobs:
      - release-ios:
          <<: *ios-publish-release

  generate_app:
    when:
      and:
        - equal: [ true, << pipeline.parameters.generate-app >> ]
    jobs:
      - generate-ios-simulator-app-using-internal-sdk:
          context:
            - verify-passkeys
            - verify-passkeys-ios
      - generate-android-sample-app-using-local-sdk:
          context:
            - verify-passkeys

  execute_e2e_tests:
      when:
        and:
        - equal: [ true, << pipeline.parameters.e2e-tests >> ]
      jobs:
        - start_execution_android_e2e_tests:
            name: start_execution_android_e2e_tests
            type: approval
        - start_execution_ios_e2e_tests:
            name: start_execution_ios_e2e_tests
            type: approval
        - generate-android-sample-app-using-local-sdk:
            context:
              - verify-passkeys
            requires:
              - start_execution_android_e2e_tests
        - generate-ios-simulator-app-using-internal-sdk:
            context:
              - verify-passkeys
              - verify-passkeys-ios
            requires:
              - start_execution_ios_e2e_tests
        - run-android-local-sdk-e2e-tests:
            context:
              - verify-passkeys
            waiting_job_name: wait-for-android-local-sdk-e2e-tests
            requires:
              - generate-android-sample-app-using-local-sdk
        - wait-for-android-local-sdk-e2e-tests:
            type: approval
            requires:
              - run-android-local-sdk-e2e-tests
        - check-local-sdk-e2e-tests-result:
            name: check-android-local-sdk-e2e-tests-result
            context:
              - verify-passkeys
            job_name_to_check: "wait-for-android-local-sdk-e2e-tests"
            requires:
              - wait-for-android-local-sdk-e2e-tests:
                  - success
                  - failed
                  - canceled
        - run-simulator-ios-local-sdk-e2e-tests:
            context:
              - verify-passkeys
            waiting_job_name: wait-for-ios-local-sdk-e2e-tests
            requires:
              - generate-ios-simulator-app-using-local-sdk
        - wait-for-ios-local-sdk-e2e-tests:
            type: approval
            requires:
              - run-simulator-ios-local-sdk-e2e-tests
        - check-local-sdk-e2e-tests-result:
            name: check-simulator-ios-sdk-e2e-tests-result
            context:
              - verify-passkeys
            job_name_to_check: "wait-for-ios-local-sdk-e2e-tests"
            requires:
              - wait-for-ios-local-sdk-e2e-tests:
                  - success
                  - failed
                  - canceled

